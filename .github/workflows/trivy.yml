name: Trivy Scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      image-matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

    - name: Parse image list
      id: parse-images
      run: |
        images=$(jq -c 'to_entries[] | {image: (.key + ":" + .value)}' wis2box-images.json | jq -s .)
        echo "Matrix: $images"
        echo "matrix=$images" >> $GITHUB_ENV

    - name: Validate JSON format
      run: |
        echo "$images" | jq empty

    - name: Set matrix output
      id: set-matrix
      run: echo "matrix=${{ steps.parse-images.outputs.matrix }}"

  trivy-scan:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.prepare-matrix.outputs.image-matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run Trivy vulnerability scanner on ${{ matrix.image.image }}
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ matrix.image.image }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
        env:
          TRIVY_DB_REPOSITORY: public.ecr.aws/aquasecurity/trivy-db:2
          TRIVY_JAVA_DB_REPOSITORY: public.ecr.aws/aquasecurity/trivy-java-db:1